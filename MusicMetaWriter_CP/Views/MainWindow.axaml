

<Window xmlns="https://github.com/avaloniaui"
        xmlns:controls="using:Avalonia.Notification.Controls"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://openxmlformats.org/markup-compatibility/2006"
        xmlns:converters="using:MusicMetaWriter_CP.Converters"
        xmlns:viewmodels="using:MusicMetaWriter_CP.ViewModels"
        d:DesignWidth="1800" d:DesignHeight="1100"
        x:Class="MusicMetaWriter_CP.Views.MainWindow"
        x:DataType="viewmodels:MainWindowViewModel"
        Title="MusicMetaWriter"
        MinWidth="1100" MinHeight="1100"
        Background="{DynamicResource ThemeBackgroundBrush}"
        WindowStartupLocation="CenterScreen"
        Icon="">

    <Window.Resources>
		<converters:NonHideableColumnConverter x:Key="NonHideableColumnConverter" />
    </Window.Resources> 

    <DockPanel>
		<!-- Top Bar -->
        <Grid DockPanel.Dock="Top" Margin="15, 15, 15, 5" ColumnDefinitions="*, Auto">
            <!-- Top Left -->
            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                <TextBlock Text="MusicMetaWriter" Classes="Header" VerticalAlignment="Center" FontWeight="Bold" />
                <TextBlock Text="by BashCode" Foreground="{DynamicResource ThemeForegroundMidBrush}" VerticalAlignment="Center" Margin="10,0"/>
                <TextBlock Text="|" Foreground="{DynamicResource ThemeForegroundMidBrush}" VerticalAlignment="Center" Margin="8,0"/>

                <Button Content="Load File(s)" Command="{Binding LoadFilesCommand}" />
                <Button Content="Load Folder" Command="{Binding LoadFolderCommand}" />
                <Button Content="Save Settings" Command="{Binding SaveSettingsCommand}" />
            </StackPanel>

            <!-- Top Right -->
            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center" HorizontalAlignment="Right">
                <TextBlock Text="|" Foreground="{DynamicResource ThemeForegroundMidBrush}" VerticalAlignment="Center" Margin="8,0"/>
                <Button Content="Reset All" Command="{Binding ResetTracksCommand}" />
                <Button Content="Batch Fill" Command="{Binding OpenBatchFillCommand}" />
                <TextBlock Text="|" Foreground="{DynamicResource ThemeForegroundMidBrush}" VerticalAlignment="Center" Margin="8,0"/>
				<Button Content="Advanced Settings" VerticalAlignment="Center" HorizontalAlignment="Right" Command="{Binding OpenAdvancedSettingsCommand}" />
            </StackPanel>
        </Grid>
        
        <!-- Bottom Bar -->
        <Grid DockPanel.Dock="Bottom" ColumnDefinitions="*,Auto">
            <Border Grid.ColumnSpan="2" CornerRadius="20" Effect="blur(10)" Margin="15,7" BoxShadow="0 10 20 0 #60000000" Opacity="0.6">
                <Border.Background>
                    <LinearGradientBrush StartPoint="0%,0%" EndPoint="100%,100%">
                        <GradientStop Color="#33FFFFFF" Offset="0" />
                        <GradientStop Color="#10FFFFFF" Offset="1" />
                    </LinearGradientBrush>
                </Border.Background>
            </Border>

			<StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8" HorizontalAlignment="Left" Margin="30,15" Opacity="0.5">
				<Button Content="Download FFMPEG !" 
                        IsVisible="{Binding !FfmpegFound}" IsEnabled="{Binding !FfmpegFound}"
                        Command="{Binding EnsureFfmpegCommand}"
                        CornerRadius="20"
                        FontWeight="Bold" Background="OrangeRed" />

                <!-- Progress Bar + Status -->
                <TextBlock Text="{Binding LoadStatus}"
                           VerticalAlignment="Center" Foreground="{DynamicResource ThemeForegroundMid}"
                           IsVisible="{Binding IsLoading}" />
            
                <ProgressBar Value="{Binding LoadProgress}"
                             Width="300"
                             Height="10"
                             IsVisible="{Binding ShowProgress}" />
            </StackPanel>

            <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8" Margin="30,10" HorizontalAlignment="Right">
                <TextBlock Text="|" Foreground="{DynamicResource ThemeForegroundMidBrush}" VerticalAlignment="Center" Margin="8,0"/>

                <!-- Export Formats -->
                <CheckBox Content="MP3" IsChecked="{Binding Export_mp3}" />
                <CheckBox Content="WAV" IsChecked="{Binding Export_wav}" />
                <CheckBox Content="FLAC" IsChecked="{Binding Export_flac}" />
                <CheckBox Content="AIFF" IsChecked="{Binding Export_aiff}" />

                <TextBlock Text="|" Foreground="{DynamicResource ThemeForegroundMidBrush}" VerticalAlignment="Center" Margin="8,0"/>

                <!-- Actions -->
                <Button Content="Open Log Folder" Command="{Binding OpenLogFolderCommand}" />
                <Button Content="Generate MP4" />
                <Button Content="Export" Command="{Binding StartExportCommand}" />
            </StackPanel>
        </Grid>
        

        <!-- Main Content -->
        <Grid ColumnDefinitions="Auto, *">
            <Border CornerRadius="20" Effect="blur(10)" Margin="15,10,15,0" BoxShadow="0 10 20 0 #60000000" Opacity="0.95">
                <Border.Background>
                    <LinearGradientBrush StartPoint="0%,0%" EndPoint="100%,100%">
                        <GradientStop Color="#11FFFFFF" Offset="0" />
                        <GradientStop Color="#22FFFFFF" Offset="0.5" />
                        <GradientStop Color="#11FFFFFF" Offset="1" />
                    </LinearGradientBrush>
                </Border.Background>
            </Border>

            <ScrollViewer Margin="30,10" Grid.Column="0" VerticalScrollBarVisibility="Hidden">
                <StackPanel Orientation="Vertical"
                            Spacing="20"
                            VerticalAlignment="Top"
                            MaxWidth="310" Width="310">

                    <!-- Notifications -->
                    <controls:NotificationMessageContainer Manager="{Binding NotificationManager}" />

                    <!-- Loudness Normalization -->
                    <StackPanel Orientation="Vertical" Spacing="8" Margin="0,0,0,20">
                        <TextBlock Text="Loudness Normalization" FontWeight="SemiBold" />
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Stretch" Spacing="8">
                            <CheckBox Content="Enable" IsChecked="{Binding Use_ln}" />
                            <ComboBox SelectedIndex="0" IsEnabled="{Binding Use_ln}" ItemsSource="{Binding LnMethods}" SelectedValue="{Binding Ln_method}" />
                        </StackPanel>
                        

                        <Border IsEnabled="{Binding Use_ln}" Background="Transparent">
                            <StackPanel Orientation="Vertical" Spacing="5">
							    <TextBlock Text="Target LUFS:" VerticalAlignment="Center" />
                                <NumericUpDown Value="{Binding Ln_target_i}" Minimum="-30" Maximum="10" Increment="0.5" />

                                <TextBlock Text="True Peak (dBTP):" VerticalAlignment="Center" />
                                <NumericUpDown Value="{Binding Ln_target_tpeak}" Minimum="-20" Maximum="10" Increment="0.5" />

                                <TextBlock Text="Loudness Range (LU):" VerticalAlignment="Center" />
                                <NumericUpDown Value="{Binding Ln_target_lu}" Minimum="0" Maximum="30" Increment="0.5" />
                            </StackPanel>
                        </Border>
                    </StackPanel>

                    <!-- File Options -->
                    <StackPanel Orientation="Vertical" Spacing="4">
                        <TextBlock Text="File Options" FontWeight="SemiBold" />
                        <CheckBox Content="Create sub-directory for each track" IsChecked="{Binding Cr_subdirectory}" />
                        <StackPanel Orientation="Horizontal" Spacing="10">
                            <CheckBox Content="Convert to:" IsChecked="{Binding ConvertBit}" />
                            <ComboBox SelectedIndex="0"
                                        ItemsSource="{Binding ConvertToBitItems}"
                                        SelectedValue="{Binding ConvertToBit}"
                                        IsEnabled="{Binding ConvertBit}" />
                            <TextBlock Text="bit" VerticalAlignment="Center" />
                        </StackPanel>
                    </StackPanel>

                    <!-- File Name -->
                    <StackPanel Orientation="Vertical" Spacing="4">
						<TextBlock Text="File Name" FontWeight="SemiBold" />
                        <CheckBox Content="Keep original filename" IsChecked="{Binding Keep_filename}" />
                        <TextBlock Text="Filename Pattern" Margin="0,8,0,0" />
                        <TextBox Text="{Binding Fn_pattern}" IsEnabled="{Binding !Keep_filename}" IsReadOnly="false" />
                        <TextBlock Text="Example: %number% - %artists% - %album% - %title%"
                                    FontSize="11" Foreground="Gray" Margin="0,4,0,0" />
                    </StackPanel>

                    <StackPanel Orientation="Vertical" Spacing="4">
                        <!-- Cover Preview -->
						<TextBlock Text="Cover Preview" FontWeight="SemiBold" />

                        <Grid RowDefinitions="*" ColumnDefinitions="*" Margin="0,10,0,10">
                            <Border Background="DarkGray"
                                    Grid.Row="0"
                                    Grid.Column="0"
                                    HorizontalAlignment="Stretch"
                                    Height="300"
                                    Width="300"
                                    CornerRadius="4">
                                <Image Source="{Binding SelectedImage}"
                                        Stretch="Uniform"
                                        StretchDirection="Both"
                                        HorizontalAlignment="Center"
                                        VerticalAlignment="Center" />
                            </Border>
                        </Grid>

                        <!-- Track Options -->
                        <Grid ColumnDefinitions="*,*">
                            <Button Content="Replace Cover"
                                    Grid.Column="0"
                                    HorizontalAlignment="Stretch"
                                    Margin="0,0,4, 0"
                                    IsEnabled="{Binding Btn_replace_enabled}"
                                    Command="{Binding ReplaceCoverCommand}" />
                             
                            <Button Content="Remove Cover"
                                    Grid.Column="1"
                                    HorizontalAlignment="Stretch"
                                    Margin="4,0,0,0"
                                    IsEnabled="{Binding Btn_remove_enabled}"
                                    Command="{Binding RemoveCoverCommand}" />
                        </Grid>

                        <Grid RowDefinitions="*,*">
                            <Button Content="Analyze Track"
                                    Grid.Column="0"
                                    HorizontalAlignment="Stretch"
                                    Margin="0, 0, 0, 4"
                                    IsEnabled="{Binding Btn_analyze_enabled}"
                                    IsVisible="False"
                                    Command="{Binding ShowAnalyzeWindowCommand}" />
                        </Grid>
                    </StackPanel>
                </StackPanel>
            </ScrollViewer>

            <!-- Main DataGrid -->
            <Border Grid.Column="1"
                    BorderBrush="Green"
                    BorderThickness="1"
                    CornerRadius="6"
                    Margin="0,10,15,0">
                <DataGrid x:Name="MyDataGrid"
                          ItemsSource="{Binding Tracks}"
                          AutoGenerateColumns="False"
                          IsReadOnly="False"
                          GridLinesVisibility="All"
                          CanUserResizeColumns="True"
                          SelectionMode="Extended"
                          SelectionChanged="MyDataGrid_SelectionChanged"
                          HorizontalAlignment="Stretch"
                          VerticalAlignment="Stretch"
                          ColumnWidth="*"
                          HorizontalScrollBarVisibility="Auto"
                          VerticalScrollBarVisibility="Auto"
                          Loaded="MyDataGrid_Loaded">

                    <DataGrid.ContextMenu>
						<ContextMenu DataContext="{Binding RelativeSource={RelativeSource AncestorType=DataGrid}, Path=DataContext}">
							<ContextMenu.Items>
                                <MenuItem Header="Show/Hide Columns">
								    <ItemsControl ItemsSource="{Binding Columns, ElementName=MyDataGrid}">
									    <ItemsControl.ItemTemplate>
										    <DataTemplate>
											    <CheckBox   Content="{Binding Header}"
                                                            IsChecked="{Binding IsVisible, Mode=TwoWay}"
                                                            IsEnabled="{Binding Header, Converter={StaticResource NonHideableColumnConverter}}"
                                                            Margin="4" />
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </MenuItem>
                            </ContextMenu.Items>
                        </ContextMenu>
                    </DataGrid.ContextMenu>

                    <DataGrid.Columns>
                        <DataGridTextColumn Header="#" Binding="{Binding TrackNumber}" Width="60" />
                        <DataGridCheckBoxColumn Header="Has Cover" Binding="{Binding HasEffectiveCover}" Width="70" IsReadOnly="True" />
                        <DataGridTemplateColumn Header="Cover" Width="100" IsReadOnly="True">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Image Source="{Binding EffectiveCoverImage}" Width="100" Height="100" Stretch="UniformToFill" />
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                        <DataGridTextColumn Header="Track Name" Binding="{Binding TrackName}" Width="*" />
                        <DataGridTextColumn Header="Album" Binding="{Binding Album}" Width="*" />
                        <DataGridTextColumn Header="Artists" Binding="{Binding Artists}" Width="*" />
                        <DataGridTextColumn Header="Genre" Binding="{Binding Genre}" Width="120" />
                        <DataGridTextColumn Header="BPM" Binding="{Binding Bpm}" Width="80" />
                        <DataGridTextColumn Header="Key" Binding="{Binding Key}" Width="80" />
                        <DataGridTextColumn Header="Bit Depth" Binding="{Binding Bits_per_sample}" Width="80" IsReadOnly="True" />
                        <DataGridTextColumn Header="Sample Rate" Binding="{Binding Sample_rate}" Width="100" IsReadOnly="True" />
                        <DataGridTextColumn Header="Path" Binding="{Binding Path}" IsReadOnly="True" Width="*" />
                        <DataGridTemplateColumn Header="Reset" Width="80">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Button Content="Reset"
                                            Command="{Binding $parent[DataGrid].DataContext.ResetTrackCommand}"
                                            CommandParameter="{Binding}"
                                            HorizontalAlignment="Center"
                                            VerticalAlignment="Center" />
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </Border>
        </Grid>
    </DockPanel>
</Window>