
<Window xmlns="https://github.com/avaloniaui"
        xmlns:controls="using:Avalonia.Notification.Controls"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://openxmlformats.org/markup-compatibility/2006"
        xmlns:converters="using:MusicMetaWriter_CP.Converters"
        xmlns:viewmodels="using:MusicMetaWriter_CP.ViewModels"
        d:DesignWidth="1800" d:DesignHeight="1050"
        x:Class="MusicMetaWriter_CP.Views.MainWindow"
        x:DataType="viewmodels:MainWindowViewModel"
        Title="MusicMetaWriter"
        MinWidth="720" MinHeight="1000"
        Background="{DynamicResource ThemeBackgroundBrush}"
        Icon="">

    <Window.Resources>
		<converters:NonHideableColumnConverter x:Key="NonHideableColumnConverter" />
    </Window.Resources>

    <DockPanel>
		<!-- Top Bar -->
        <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Spacing="8" Margin="12,10">
            <TextBlock Text="MusicMetaWriter" Classes="Header" VerticalAlignment="Center"/>
            <TextBlock Text="by BashCode" Foreground="{DynamicResource ThemeForegroundMidBrush}" VerticalAlignment="Center" Margin="10,0"/>
            <TextBlock Text="|" Foreground="{DynamicResource ThemeForegroundMidBrush}" VerticalAlignment="Center" Margin="8,0"/>

            <Button Content="Load File(s)" Command="{Binding LoadFilesCommand}" />
            <Button Content="Load Folder" Command="{Binding LoadFolderCommand}" />
            <Button Content="Save Settings" Command="{Binding SaveSettingsCommand}" />
        </StackPanel>

        <!-- Bottom Bar -->
        <StackPanel DockPanel.Dock="Bottom" Orientation="Horizontal" Spacing="8" Margin="12,10" HorizontalAlignment="Right">
            <TextBlock Text="{Binding LoadStatus}"
                       VerticalAlignment="Center"
                       IsVisible="{Binding IsLoading}" />
            
            <ProgressBar Value="{Binding LoadProgress}"
                         Width="300"
                         Height="10"
                         IsVisible="{Binding IsLoading}" />

            <TextBlock Text="|" Foreground="{DynamicResource ThemeForegroundMidBrush}" VerticalAlignment="Center" Margin="8,0"/>

            <CheckBox Content="MP3" IsChecked="{Binding Export_mp3}" />
            <CheckBox Content="WAV" IsChecked="{Binding Export_wav}" />
            <CheckBox Content="FLAC" IsChecked="{Binding Export_flac}" />
            <CheckBox Content="AIFF" IsChecked="{Binding Export_aiff}" />

            <TextBlock Text="|" Foreground="{DynamicResource ThemeForegroundMidBrush}" VerticalAlignment="Center" Margin="8,0"/>

            <Button Content="Open Log Folder" />
            <Button Content="Open Log" />
            <Button Content="Generate MP4" />
            <Button Content="Export" />
        </StackPanel>

        <!-- Main Content -->
        <Grid ColumnDefinitions="Auto, *">

            <ScrollViewer Margin="30,10">
                <StackPanel Orientation="Vertical"
                            Spacing="20"
                            VerticalAlignment="Top"
                            MaxWidth="310" Width="310">

                    <!-- Notifications -->
                    <controls:NotificationMessageContainer Manager="{Binding NotificationManager}" />

                    <!-- Loudness Normalization -->
                    <StackPanel Orientation="Vertical" Spacing="4" Margin="0,0,0,20">
                        <TextBlock Text="Loudness Normalization" FontWeight="SemiBold" />
                        <CheckBox Content="Enable" IsChecked="{Binding Use_ln}" />

                        <Border IsEnabled="{Binding Use_ln}" Background="Transparent">
                            <StackPanel Orientation="Vertical" Spacing="5">
							    <TextBlock Text="Target LUFS:" VerticalAlignment="Center" />
                                <NumericUpDown Value="{Binding Ln_target_i}" Minimum="-30" Maximum="10" Increment="0.5" />

                                <TextBlock Text="True Peak (dBTP):" VerticalAlignment="Center" />
                                <NumericUpDown Value="{Binding Ln_target_tpeak}" Minimum="-20" Maximum="10" Increment="0.5" />

                                <TextBlock Text="Loudness Range (LU):" VerticalAlignment="Center" />
                                <NumericUpDown Value="{Binding Ln_target_lu}" Minimum="0" Maximum="30" Increment="0.5" />
                            </StackPanel>
                        </Border>
                    </StackPanel>

                    <!-- File Name Pattern -->
                    <StackPanel Orientation="Vertical" Spacing="4">
                        <TextBlock Text="File Options" FontWeight="SemiBold" />
                        <CheckBox Content="Create sub-directory for each track" IsChecked="{Binding Cr_subdirectory}" />
                        <CheckBox Content="Keep original filename" IsChecked="{Binding Keep_filename}" />
                        <TextBox Text="{Binding Fn_pattern}" IsEnabled="{Binding !Keep_filename}" IsReadOnly="false" />
                        <TextBlock Text="Example: %number% - %artists% - %album% - %title%"
                                   FontSize="11" Foreground="Gray" Margin="0,4,0,0" />
                    </StackPanel>

                    <!-- Cover Preview -->
                    <StackPanel Orientation="Vertical" Spacing="4">
						<TextBlock Text="Cover Preview" FontWeight="SemiBold" />

                        <Grid RowDefinitions="*" ColumnDefinitions="*" Margin="0,10,0,10">
                            <Border Background="DarkGray"
                                    Grid.Row="0"
                                    Grid.Column="0"
                                    HorizontalAlignment="Stretch"
                                    Height="300"
                                    Width="300"
                                    CornerRadius="4">
                                <Image Source="{Binding SelectedImage}"
                                       Stretch="Uniform"
                                       StretchDirection="Both"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center" />
                            </Border>
                        </Grid>

                        <Grid ColumnDefinitions="*,*">
                            <Button Content="Replace Cover"
                                    Grid.Column="0"
                                    HorizontalAlignment="Stretch"
                                    Margin="0,0,4, 0"
                                    IsEnabled="{Binding Btn_replace_enabled}"
                                    Command="{Binding ReplaceCoverCommand}" />
                             
                            <Button Content="Remove Cover"
                                    Grid.Column="1"
                                    HorizontalAlignment="Stretch"
                                    Margin="4,0,0,0"
                                    IsEnabled="{Binding Btn_remove_enabled}"
                                    Command="{Binding RemoveCoverCommand}" />
                        </Grid>

                        <Grid RowDefinitions="*,*">
                            <Button Content="Analyze BPM"
                                    Grid.Column="0"
                                    HorizontalAlignment="Stretch"
                                    Margin="0, 0, 0, 4"
                                    IsEnabled="{Binding Btn_bpm_enabled}" />

                            <Button Content="Analyze Key"
                                    Grid.Row="1"
                                    HorizontalAlignment="Stretch"
                                    Margin="0, 0, 0, 0"
                                    IsEnabled="{Binding Btn_key_enabled}" />
                        </Grid>
                    </StackPanel>
                </StackPanel>
            </ScrollViewer>

            <!-- Main DataGrid -->
            <Border Grid.Column="1"
                    BorderBrush="Green"
                    BorderThickness="1"
                    CornerRadius="6"
                    Margin="0,10,15,0">
                <DataGrid ItemsSource="{Binding Tracks}"
                          AutoGenerateColumns="False"
                          IsReadOnly="False"
                          GridLinesVisibility="All"
                          CanUserResizeColumns="True"
                          SelectionMode="Extended"
                          SelectionChanged="MyDataGrid_SelectionChanged"
                          HorizontalAlignment="Stretch"
                          VerticalAlignment="Stretch"
                          ColumnWidth="*"
                          HorizontalScrollBarVisibility="Auto"
                          VerticalScrollBarVisibility="Auto"
                          Loaded="MyDataGrid_Loaded"
                          x:Name="MyDataGrid">

                    <DataGrid.ContextMenu>
						<ContextMenu DataContext="{Binding RelativeSource={RelativeSource AncestorType=DataGrid}, Path=DataContext}">
							<ContextMenu.Items>
                                <MenuItem Header="Show/Hide Columns">
								    <ItemsControl ItemsSource="{Binding Columns, ElementName=MyDataGrid}">
									    <ItemsControl.ItemTemplate>
										    <DataTemplate>
											    <CheckBox   Content="{Binding Header}"
                                                            IsChecked="{Binding IsVisible, Mode=TwoWay}"
                                                            IsEnabled="{Binding Header, Converter={StaticResource NonHideableColumnConverter}}"
                                                            Margin="4" />
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </MenuItem>
                            </ContextMenu.Items>
                        </ContextMenu>
                    </DataGrid.ContextMenu>

                    <DataGrid.Columns>
                        <DataGridTextColumn Header="#" Binding="{Binding TrackNumber}" Width="60" />

                        <DataGridCheckBoxColumn Header="Has Cover" Binding="{Binding HasEffectiveCover}" Width="70" IsReadOnly="True" />

                        <DataGridTemplateColumn Header="Cover" Width="100">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Image Source="{Binding EffectiveCoverImage}" Width="100" Height="100" Stretch="UniformToFill" />
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>

                        <DataGridTextColumn Header="Track Name" Binding="{Binding TrackName}" Width="*" />

                        <DataGridTextColumn Header="Album" Binding="{Binding Album}" Width="*" />

                        <DataGridTextColumn Header="Artists" Binding="{Binding Artists}" Width="*" />

                        <DataGridTextColumn Header="Genre" Binding="{Binding Genre}" Width="120" />

                        <DataGridTextColumn Header="BPM" Binding="{Binding Bpm}" Width="80" />

                        <DataGridTextColumn Header="Key" Binding="{Binding Key}" Width="80" />

                        <DataGridTextColumn Header="Bit Depth" Binding="{Binding Bits_per_sample}" Width="80" />

                        <DataGridTextColumn Header="Sample Rate" Binding="{Binding Sample_rate}" Width="100" />

                        <DataGridTextColumn Header="Path" Binding="{Binding Path}" IsReadOnly="True" Width="*" />

                        <DataGridTemplateColumn Header="Reset" Width="80">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Button Content="Reset" />
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </Border>
        </Grid>
    </DockPanel>
</Window>